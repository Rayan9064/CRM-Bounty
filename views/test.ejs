<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quill Editor with Paste Image and Upload</title>
    <!-- Quill CSS -->
    <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
    <!-- Quill JS -->
    <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
    <style>
        #editor-container {
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 10px;
            background-color: #f9f9f9;
            overflow: auto;
            /* Allows scrollbars for overflowing content */
            resize: both;
            /* Enables resizing */
            min-height: 500px;
            /* Minimum height */
            min-width: 1000px;
            /* Minimum width */
            max-height: 1000px;
            /* Optional maximum height */
            max-width: 1500px;
            /* Optional maximum width */
        }

        #upload-button {
            margin-top: 10px;
        }
    </style>
</head>

<body>
    <div id="editor-container" style="height: 150px; width: 300px;"></div>
    <button id="upload-button">Upload Image</button>

    <!-- Initialize Quill Editor -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Initialize the Quill editor
            const quill = new Quill('#editor-container', {
                theme: 'snow',
                placeholder: 'Copy/Paste Flight Details or Travel Itinerary',
                modules: {
                    toolbar: [
                        ['bold', 'italic', 'underline'], // Text styling options
                        [{ 'font': [] }],               // Font selector
                        [{ 'color': [] }, { 'background': [] }], // Text color and background
                        [{ 'align': [] }],              // Alignment options
                        ['link', 'image', 'code-block'], // Media and code options, including image
                        [{ 'list': 'ordered' }, { 'list': 'bullet' }], // List options
                        ['clean']                       // Clear formatting
                    ]
                }
            });

            let pastedImageBase64 = null; // To store the pasted image's Base64 data

            // Handle paste event to detect and capture pasted images
            quill.root.addEventListener('paste', function (event) {
                const clipboardItems = event.clipboardData.items;
                for (let i = 0; i < clipboardItems.length; i++) {
                    const item = clipboardItems[i];
                    if (item.type.indexOf('image') !== -1) {
                        const blob = item.getAsFile();
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            pastedImageBase64 = e.target.result; // Save the Base64 data
                            const range = quill.getSelection();
                            quill.insertEmbed(range.index, 'image', pastedImageBase64); // Display in editor
                        };
                        reader.readAsDataURL(blob);
                        event.preventDefault();
                    }
                }
            });

            // Upload button click event
            const uploadButton = document.getElementById('upload-button');
            uploadButton.addEventListener('click', function () {
                if (pastedImageBase64) {
                    // Convert Base64 to Blob
                    const byteString = atob(pastedImageBase64.split(',')[1]);
                    const mimeString = pastedImageBase64.split(',')[0].split(':')[1].split(';')[0];
                    const arrayBuffer = new ArrayBuffer(byteString.length);
                    const uintArray = new Uint8Array(arrayBuffer);

                    for (let i = 0; i < byteString.length; i++) {
                        uintArray[i] = byteString.charCodeAt(i);
                    }

                    const blob = new Blob([arrayBuffer], { type: mimeString });
                    const formData = new FormData();
                    formData.append('image', blob, 'pasted-image.png'); // Name of the file

                    // Send the image to the server
                    fetch('/upload', {
                        method: 'POST',
                        body: formData,
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                alert("Image uploaded successfully! File path: " + data.filePath);
                            } else {
                                alert("Image upload failed: " + data.message);
                            }
                        })
                        .catch(err => {
                            console.error("Upload error:", err);
                            alert("An error occurred while uploading the image.");
                        });
                } else {
                    alert("No image has been pasted yet.");
                }
            });

        });
    </script>
</body>

</html>